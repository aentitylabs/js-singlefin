!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.jssinglefin=t():e.jssinglefin=t()}(this,(function(){return(()=>{var e={180:function(e){e.exports=(()=>{"use strict";var e={534:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Bridge=void 0,t.Bridge=class{}},665:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DeleteSourceAction=void 0;const r=i(608),s=i(58);class n extends s.SourceAction{constructor(e){super("DeleteSourceAction",e)}sync(e){const t=this.entity.serialize(),i=r.EntityFactory.buildEntityDataFromSchema(t);this.validateDelete(i),e.delete(i)}}t.DeleteSourceAction=n},753:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Entity=void 0;const r=i(608),s=i(92),n=i(190);t.Entity=class{constructor(e,t,i,s){let o;this._properties={},this._isReferenced=!1,this._source=new n.NullSource,this._isItem=!1,this._isCollection=!1,this._item={},this._entityStore=e,this._name=t,this._key=t,this._item=s,this._isCollection=!!s,null!=i&&null!=i&&(this._key=i.getKey()+"=>"+this._key,this._isReferenced=!0,o=i._source),this._ref=i,this._entityStore.register(this,o),i||(this._ref=this,this._entityStore.load(this)),this._item&&(this._itemPrototype=r.EntityFactory.newEntity(this._entityStore,this._item,this))}setKey(e){this._key=e}getKey(){return this._key}setName(e){this._name=e}getName(){return this._name}getRef(){return this._ref}getProperties(){return this._properties}getSource(){return this._source}getEntityStore(){return this._entityStore}setSource(e){this._source=e}isReferenced(){return this._isReferenced}isCollection(){return this._isCollection}setIsItem(e){this._isItem=e}isItem(){return this._isItem}getItem(){return this._item}getItemPrototype(){return this._itemPrototype}delete(){this._entityStore.delete(this)}get(e){return this._properties[e].value}add(){const e=r.EntityFactory.newEntity(this._entityStore,this._item,this);e.deserialize(this.getItem());const t=Object.keys(this.getProperties()).length;return this.getProperties()[t]=e,e.setKey(e.getKey()+"["+t+"]"),e.setIsItem(!0),this.getEntityStore().register(e,this.getSource()),this.getEntityStore().update(e),this.getEntityStore().load(this),e}remove(e){const t=this.get(e);this.getEntityStore().delete(t),this.getEntityStore().load(this)}serialize(){const e={};for(var t in e.entity=this.getName(),e.properties={},e.ref=this.isReferenced(),this.getProperties())e.properties[t]=this.getProperties()[t].serialize();return e}deserialize(e){if(this.setName(e.entity),!e.properties)return;let t=0;for(let i in e.properties){const r=new s.EntityProperty(this.getEntityStore(),this);if(r.deserialize(e.properties[i]),this.getProperties()[i]=r,this.isCollection()){const e=r.value;e.setKey(e.getKey()+"["+t+"]"),e.setIsItem(!0),this.getEntityStore().register(e,this.getSource())}t++}}}},608:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EntityFactory=void 0;const r=i(753),s=i(557);class n{static newEntity(e,t,i){let n=null;return n=t.collectionItem?new r.Entity(e,t.entity,i,t.collectionItem):new r.Entity(e,t.entity,i),n.deserialize(t),new Proxy(n,new s.EntityHandler)}static buildEntitySchemaFromData(e,t){const i={};i.entity=e.getName(),i.properties={},i.ref=e.isReferenced();for(let r in t)!0===e.isCollection()?(i.collectionItem=e.getItem(),e.getItemPrototype()&&(i.properties[r]=n.buildEntitySchemaFromData(e.getItemPrototype(),t[r]))):!0===e.getProperties()[r].isEntity?i.properties[r]=n.buildEntitySchemaFromData(e.getProperties()[r].value,t[r]):i.properties[r]={value:t[r]};return i}static buildEntityDataFromSchema(e){const t={};for(let i in e.properties)e.properties[i].entity?t[i]=n.buildEntityDataFromSchema(e.properties[i]):t[i]=e.properties[i].value;return t}}t.EntityFactory=n},557:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EntityHandler=void 0,t.EntityHandler=class{get(e,t,i){return e.getProperties()[t]?e.getProperties()[t].value:e[t]}set(e,t,i){return e.getProperties()[t]?(e.getProperties()[t].value=i,e.getEntityStore().update(e),!0):(e[t]=i,!0)}}},92:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EntityProperty=void 0;const r=i(608);t.EntityProperty=class{constructor(e,t){this._isEntity=!1,this._entityStore=e,this._ref=t}get isEntity(){return this._isEntity}get value(){return this._value}set value(e){this._value=e}serialize(){return!0===this._isEntity?this._value.serialize():{value:this._value}}deserialize(e){if(e.entity){const t=!0===e.ref?this._ref:void 0;return this._value=r.EntityFactory.newEntity(this._entityStore,e,t),this._isEntity=!0,void this._value.deserialize(e)}this._value=e.value}}},758:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EntityStore=void 0;const r=i(665),s=i(608),n=i(328),o=i(190),c=i(172),l=i(246);t.EntityStore=class{constructor(){this._sources={},this._entities={},this._actions={}}get actions(){return this._actions}addSource(e,t){this._sources[e]=t}register(e,t){this._entities[e.getKey()]=e,t?e.setSource(t):this._sources[e.getName()]?e.setSource(this._sources[e.getName()]):e.setSource(new o.NullSource)}sync(){for(;Object.keys(this._actions).length>0;){const e=Object.keys(this._actions)[0],t=this._actions[e];t.sync(t.entity.getSource()),delete this._actions[e]}}syncTo(e){return new Promise(((t,i)=>{const r={};for(const e in this._actions){const t=this._actions[e];t.sync(t.entity.getSource()),r[e]=c.SourceActionFactory.serialize(t)}e.send(r,(e=>{for(;Object.keys(this._actions).length>0;){const t=Object.keys(this._actions)[0],i=this._actions[t],r=i.entity.getName();e[r]&&(i.entity.deserialize(e[r]),this._sources[r]&&i.sync(this._sources[r])),delete this._actions[t]}t()}))}))}syncFrom(e,t,i){const r={},n={};for(const e in t){const i=t[e];this._entities[i.entityKey]||(this._entities[i.entityKey]=s.EntityFactory.newEntity(this,i.entity,this._entities[i.refKey]));const o=this._entities[i.entityKey];o.deserialize(i.entity),r[e]=c.SourceActionFactory.deserialize(i,o);const l=r[e].entity.getName();this._sources[l]&&(r[e].sync(this._sources[l]),n[l]=r[e].entity)}i(),this.sync();const o={};for(const e in n)o[e]=n[e].serialize();e.reply(o)}load(e){if(e.isReferenced()&&!e.isItem()&&e.getRef())return this.load(e.getRef());this._actions[e.getKey()+"::load"]=new n.LoadSourceAction(e)}update(e){if(e.isReferenced()&&!e.isItem()&&e.getRef())return this.update(e.getRef());this._actions[e.getKey()+"::update"]=new l.UpdateSourceAction(e)}delete(e){if(e.isReferenced()&&!e.isItem()&&e.getRef())return this.delete(e.getRef());this._actions[e.getKey()+"::delete"]=new r.DeleteSourceAction(e)}}},328:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LoadSourceAction=void 0;const r=i(608),s=i(58);class n extends s.SourceAction{constructor(e){super("LoadSourceAction",e)}sync(e){const t=this.entity.serialize(),i=r.EntityFactory.buildEntityDataFromSchema(t),s=e.load(i);this.validateLoad(s);const n=r.EntityFactory.buildEntitySchemaFromData(this.entity,s);this.entity.deserialize(n)}}t.LoadSourceAction=n},190:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NullSource=void 0;const r=i(886);class s extends r.Source{load(e){return e}update(e){return e}delete(e){}}t.NullSource=s},625:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NullSourceAction=void 0;const r=i(58);class s extends r.SourceAction{constructor(e){super("NullSourceAction",e)}sync(e){throw new Error("NullSourceAction: method not implemented.")}}t.NullSourceAction=s},886:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Source=void 0,t.Source=class{}},58:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SourceAction=void 0,t.SourceAction=class{constructor(e,t){this._type=e,this._entity=t}get type(){return this._type}get entity(){return this._entity}set entity(e){this._entity=e}validateLoad(e){}validateUpdate(e){}validateDelete(e){}}},172:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SourceActionFactory=void 0;const r=i(665),s=i(328),n=i(625),o=i(246);t.SourceActionFactory=class{static serialize(e){const t={};return t.type=e.type,t.entityKey=e.entity.getKey(),t.entityType=e.entity.getName(),t.entity=e.entity.serialize(),t.refKey=e.entity.getRef()?e.entity.getRef().getKey():void 0,t}static deserialize(e,t){switch(e.type){case"LoadSourceAction":return new s.LoadSourceAction(t);case"UpdateSourceAction":return new o.UpdateSourceAction(t);case"DeleteSourceAction":return new r.DeleteSourceAction(t)}return new n.NullSourceAction(t)}}},246:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateSourceAction=void 0;const r=i(608),s=i(58);class n extends s.SourceAction{constructor(e){super("UpdateSourceAction",e)}sync(e){const t=this.entity.serialize(),i=r.EntityFactory.buildEntityDataFromSchema(t);this.validateUpdate(i);const s=e.update(i),n=r.EntityFactory.buildEntitySchemaFromData(this.entity,s);this.entity.deserialize(n)}}t.UpdateSourceAction=n}},t={};function i(r){var s=t[r];if(void 0!==s)return s.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,i),n.exports}var r={};return(()=>{var e=r;Object.defineProperty(e,"__esModule",{value:!0}),e.Bridge=e.Source=e.EntityFactory=e.EntityStore=void 0;const t=i(758);Object.defineProperty(e,"EntityStore",{enumerable:!0,get:function(){return t.EntityStore}});const s=i(608);Object.defineProperty(e,"EntityFactory",{enumerable:!0,get:function(){return s.EntityFactory}});const n=i(886);Object.defineProperty(e,"Source",{enumerable:!0,get:function(){return n.Source}});const o=i(534);Object.defineProperty(e,"Bridge",{enumerable:!0,get:function(){return o.Bridge}})})(),r})()},46:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Follower=void 0;const r=i(591);t.Follower=class{constructor(e){this._state=new r.NullState,this._influencers=[],this._states={},this._trendStates={},this._name=e,this._state.follower=this}get name(){return this._name}addInfluencer(e){this._influencers.push(e)}addState(e,t){t.name=e,t.follower=this,this._states[e]=t}subscribe(e){this.addInfluencer(e),e.subscribe(this)}follow(e){this._influencers.forEach((t=>{t.follow(e,this._name)}))}on(e,t){this._trendStates[e]=this._states[t]}changeState(e){this._state=this._states[e]}handle(e,t){this._state.handle(e,t)}onTrendChange(e,t){this._trendStates[e]&&(this._state=this._trendStates[e]),this.handle(e,t)}set state(e){this._state=e}serialize(){return{name:this._name,state:this._state.name}}deserialize(e){this._name=e.name,this._state=this._states[e.state]}}},886:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Influencer=void 0,t.Influencer=class{constructor(){this._followers={},this._trends={}}subscribe(e){this._followers[e.name]=e}init(e){for(const t in e){const i=e[t];for(let e=0;e<i.length;e++)this._followers[i[e].name]&&this._followers[i[e].name].deserialize(i[e])}}follow(e,t){this._trends[e]||(this._trends[e]=[]),this._trends[e].push(this._followers[t])}newTrend(e,t){const i=this._trends[e];if(i)for(let r=0;r<i.length;r++)i[r].onTrendChange(e,t)}serialize(){const e={followers:{}};for(const t in this._followers){const i=this._followers[t];e.followers[t]=i.serialize()}return e}}},591:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NullState=void 0;const r=i(445);class s extends r.State{handle(e,t){}}t.NullState=s},445:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.State=void 0,t.State=class{constructor(){this._name=""}set name(e){this._name=e}get name(){return this._name}set follower(e){this._follower=e}changeState(e){this._follower&&this._follower.changeState(e)}}},328:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Singlefin=void 0;const r=i(886),s=i(180),n=i(180),o=i(191);class c extends r.Influencer{constructor(){super(),this._entityStore=new s.EntityStore,this._currentTrend=n.EntityFactory.newEntity(this._entityStore,{entity:"Singlefin",ref:!1,properties:{trend:{value:""},trends:{value:{}}}}),this._entityStore.addSource("Singlefin",new o.SinglefinSource)}loadModel(e){return new Promise(((t,i)=>{e.load((e=>{this._model=n.EntityFactory.newEntity(this._entityStore,e),t()}))}))}setModel(e){this._model=n.EntityFactory.newEntity(this._entityStore,e)}get model(){return this._model}addSource(e,t){this._entityStore.addSource(e,t)}inform(e){const t=this._trends[e];this._currentTrend.trend=e,this._currentTrend.trends[e]=this.serializeFollowers(t),this._entityStore.sync(),this.newTrend(e,this._model),this._entityStore.sync()}informTo(e,t){const i=this._trends[t];return this._currentTrend.trend=t,this._currentTrend.trends[t]=this.serializeFollowers(i),this._entityStore.syncTo(e).then((()=>(this.init(this._currentTrend.trends),this.newTrend(this._currentTrend.trend,this._model),this._entityStore.syncTo(e))))}informFrom(e,t){this._entityStore.syncFrom(e,t,(()=>{this.init(this._currentTrend.trends),this.newTrend(this._currentTrend.trend,this._model);const e=this._trends[this._currentTrend.trend];this._currentTrend.trends[this._currentTrend.trend]=this.serializeFollowers(e)}))}serializeFollowers(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].serialize());return t}}t.Singlefin=c},191:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SinglefinSource=void 0;const r=i(180);class s extends r.Source{load(e){return e}update(e){return e}delete(e){}}t.SinglefinSource=s}},t={};function i(r){var s=t[r];if(void 0!==s)return s.exports;var n=t[r]={exports:{}};return e[r].call(n.exports,n,n.exports,i),n.exports}var r={};return(()=>{"use strict";var e=r;Object.defineProperty(e,"__esModule",{value:!0}),e.State=e.Follower=e.Singlefin=void 0;const t=i(328);Object.defineProperty(e,"Singlefin",{enumerable:!0,get:function(){return t.Singlefin}});const s=i(46);Object.defineProperty(e,"Follower",{enumerable:!0,get:function(){return s.Follower}});const n=i(445);Object.defineProperty(e,"State",{enumerable:!0,get:function(){return n.State}})})(),r})()}));
//# sourceMappingURL=singlefin.js.map